rule php_obfuscation_and_persistence
{
    meta:
        description = "Detects PHP obfuscation, backdoor persistence, and sandbox evasion techniques"
        author = "php_obfuscation"
        version = "1.0"

    strings:
        $obfu_var_func = /\$[a-zA-Z0-9_]{1,32}\s*\(/
        $obfu_concat = /['"][a-z]{1,4}['"]\s*\.\s*['"][a-z]{1,4}['"]/
        $obfu_chr_ord = /\b(chr|ord)\s*\(/ nocase

        $persist_file_put = /file_put_contents\s*\(\s*['"]\..{1,100}\/[a-zA-Z0-9_]+\.php['"]/ nocase
        $persist_htaccess_write = /file_put_contents\s*\(\s*['"]\.htaccess['"]/ nocase
        $persist_upload_shell = /file_put_contents\s*\(\s*\$_POST\[['"][a-z0-9_]+['"]\]\s*,\s*\$_POST\[['"][a-z0-9_]+['"]\]\s*\)/ nocase

        $env_disable_func = /ini_set\s*\(\s*['"]disable_functions['"]/ nocase

        $eval = "eval"
        $base64_decode = "base64_decode"

    condition:
        filesize < 2MB and
        (
            (#obfu_var_func >= 2 and @obfu_var_func[1] - @obfu_var_func[0] < 500 and $base64_decode) or
            (1 of ($obfu_concat, $obfu_chr_ord) and $eval and @obfu_concat[1] - @eval[1] < 300) or
            (1 of ($persist_htaccess_write, $persist_upload_shell)) or
            ($persist_file_put and $obfu_var_func) or
            $env_disable_func
        )
}
